# ë°±ì—”ë“œ CI íŒŒì´í”„ë¼ì¸
# Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° S3 ì—…ë¡œë“œ
name: Backend CI

on:
  push:
    branches: [ dddd ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [ dddd]
    paths:
      - 'backend/**'

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  AWS_REGION: ap-northeast-2
  S3_BUCKET: 8-ktb-chat-common
  IMAGE_NAME: ktb-chat-backend
  
jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  test:
    runs-on: ubuntu-latest
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./backend
      run: npm ci

    - name: ì½”ë“œ ë¦°íŒ… (ESLint)
      working-directory: ./backend
      run: |
        # ESLintê°€ ì„¤ì¹˜ë˜ì–´ ìžˆë‹¤ë©´ ì‹¤í–‰, ì—†ë‹¤ë©´ ìŠ¤í‚µ
        if npm list eslint >/dev/null 2>&1; then
          npm run lint
        else
          echo "ESLint not configured, skipping..."
        fi
      continue-on-error: true

    - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      working-directory: ./backend
      run: |
        # í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ìžˆë‹¤ë©´ ì‹¤í–‰, ì—†ë‹¤ë©´ ìŠ¤í‚µ
        if npm run | grep -q "test"; then
          npm test
        else
          echo "No test script found, skipping..."
        fi
      continue-on-error: true

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° S3 ì—…ë¡œë“œ
  build-and-upload:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: AWS ìžê²©ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3

    - name: ë¹Œë“œ ë©”íƒ€ë°ì´í„° ìƒì„±
      id: meta
      run: |
        # Git ì»¤ë°‹ í•´ì‹œì˜ ì§§ì€ ë²„ì „ ìƒì„±
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        # ë¸Œëžœì¹˜ ì´ë¦„ ì •ê·œí™” (ìŠ¬ëž˜ì‹œë¥¼ í•˜ì´í”ˆìœ¼ë¡œ ë³€ê²½)
        BRANCH_NAME=$(echo ${{ github.ref_name }} | sed 's/\//-/g')
        
        # íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„±
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          TAG="latest"
          VERSION_TAG="${TIMESTAMP}-${SHORT_SHA}"
        else
          TAG="${BRANCH_NAME}-${SHORT_SHA}"
          VERSION_TAG="${BRANCH_NAME}-${TIMESTAMP}-${SHORT_SHA}"
        fi
        
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      working-directory: ./backend
      run: |
        echo "ðŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œìž‘..."
        
        # í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ
        docker build \
          --target production \
          --tag ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }} \
          --tag ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version_tag }} \
          --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
          --label "org.opencontainers.image.revision=${{ github.sha }}" \
          --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          .
          
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
        
        # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
        docker images | grep ${{ env.IMAGE_NAME }}

    - name: Docker ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸
      run: |
        echo "ðŸ§ª Docker ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸ ì‹œìž‘..."
        
        # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
        docker run --name test-container -d \
          -p 5000:5000 \
          -e NODE_ENV=test \
          -e MONGO_URI=mongodb://localhost:27017/test \
          -e JWT_SECRET=test-secret \
          ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
        
        # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (ìµœëŒ€ 30ì´ˆ)
        echo "í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘..."
        sleep 10
        
        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        if docker ps | grep -q test-container; then
          echo "âœ… ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ìžˆìŠµë‹ˆë‹¤"
        else
          echo "âŒ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨"
          docker logs test-container
          exit 1
        fi
        
        # ì»¨í…Œì´ë„ˆ ì •ë¦¬
        docker stop test-container
        docker rm test-container

    - name: Docker ì´ë¯¸ì§€ë¥¼ TAR íŒŒì¼ë¡œ ì €ìž¥
      run: |
        echo "ðŸ“¦ Docker ì´ë¯¸ì§€ë¥¼ TAR íŒŒì¼ë¡œ ì €ìž¥ ì¤‘..."
        
        # ì´ë¯¸ì§€ë¥¼ tar íŒŒì¼ë¡œ ì €ìž¥
        docker save \
          ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }} \
          ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version_tag }} \
          | gzip > backend-${{ steps.meta.outputs.version_tag }}.tar.gz
        
        # íŒŒì¼ í¬ê¸° í™•ì¸
        ls -lh backend-${{ steps.meta.outputs.version_tag }}.tar.gz
        
        echo "âœ… TAR íŒŒì¼ ìƒì„± ì™„ë£Œ"

    - name: S3ì— Docker ì´ë¯¸ì§€ ì—…ë¡œë“œ
      run: |
        echo "â˜ï¸ S3ì— Docker ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œìž‘..."
        
        # S3 ë²„í‚· ì¡´ìž¬ í™•ì¸
        if ! aws s3 ls s3://${{ env.S3_BUCKET }} >/dev/null 2>&1; then
          echo "âŒ S3 ë²„í‚·ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${{ env.S3_BUCKET }}"
          exit 1
        fi
        
        # S3ì— ì—…ë¡œë“œ (ë°±ì—”ë“œ ì „ìš© í´ë”)
        aws s3 cp backend-${{ steps.meta.outputs.version_tag }}.tar.gz \
          s3://${{ env.S3_BUCKET }}/backend/images/backend-${{ steps.meta.outputs.version_tag }}.tar.gz \
          --metadata "commit-sha=${{ github.sha }},build-timestamp=${{ steps.meta.outputs.timestamp }},branch=${{ github.ref_name }}"
        
        # latest íƒœê·¸ì¸ ê²½ìš° latest íŒŒì¼ë„ ì—…ë¡œë“œ
        if [[ "${{ steps.meta.outputs.tag }}" == "latest" ]]; then
          aws s3 cp backend-${{ steps.meta.outputs.version_tag }}.tar.gz \
            s3://${{ env.S3_BUCKET }}/backend/images/backend-latest.tar.gz \
            --metadata "commit-sha=${{ github.sha }},build-timestamp=${{ steps.meta.outputs.timestamp }},branch=${{ github.ref_name }}"
        fi
        
        echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ"

    - name: ë¹Œë“œ ì •ë³´ S3ì— ì—…ë¡œë“œ
      run: |
        echo "ðŸ“„ ë¹Œë“œ ì •ë³´ íŒŒì¼ ìƒì„± ë° ì—…ë¡œë“œ..."
        
        # ë¹Œë“œ ì •ë³´ JSON íŒŒì¼ ìƒì„±
        cat > build-info.json << EOF
        {
          "buildTimestamp": "${{ steps.meta.outputs.timestamp }}",
          "commitSha": "${{ github.sha }}",
          "shortSha": "${{ steps.meta.outputs.short_sha }}",
          "branch": "${{ github.ref_name }}",
          "tag": "${{ steps.meta.outputs.tag }}",
          "versionTag": "${{ steps.meta.outputs.version_tag }}",
          "repository": "${{ github.repository }}",
          "workflow": "${{ github.workflow }}",
          "runId": "${{ github.run_id }}",
          "imageName": "${{ env.IMAGE_NAME }}",
          "imageSize": "$(stat -c%s backend-${{ steps.meta.outputs.version_tag }}.tar.gz) bytes"
        }
        EOF
        
        # S3ì— ë¹Œë“œ ì •ë³´ ì—…ë¡œë“œ (ë°±ì—”ë“œ ì „ìš© í´ë”)
        aws s3 cp build-info.json \
          s3://${{ env.S3_BUCKET }}/backend/build-info/backend-${{ steps.meta.outputs.version_tag }}.json
        
        # latestì¸ ê²½ìš° latest ë¹Œë“œ ì •ë³´ë„ ì—…ë¡œë“œ
        if [[ "${{ steps.meta.outputs.tag }}" == "latest" ]]; then
          aws s3 cp build-info.json \
            s3://${{ env.S3_BUCKET }}/backend/build-info/backend-latest.json
        fi

    - name: ì •ë¦¬ ìž‘ì—…
      if: always()
      run: |
        echo "ðŸ§¹ ìž„ì‹œ íŒŒì¼ ì •ë¦¬..."
        rm -f backend-${{ steps.meta.outputs.version_tag }}.tar.gz
        rm -f build-info.json
        
        # Docker ì´ë¯¸ì§€ ì •ë¦¬
        docker rmi ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }} || true
        docker rmi ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version_tag }} || true

    - name: ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ðŸŽ‰ ë°±ì—”ë“œ CI ë¹Œë“œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ ë¹Œë“œ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëžœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì´ë¯¸ì§€ íƒœê·¸**: ${{ steps.meta.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë²„ì „ íƒœê·¸**: ${{ steps.meta.outputs.version_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **S3 ë²„í‚·**: ${{ env.S3_BUCKET }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ S3 ì—…ë¡œë“œ ê²½ë¡œ" >> $GITHUB_STEP_SUMMARY
        echo "- ì´ë¯¸ì§€: \`s3://${{ env.S3_BUCKET }}/backend/images/backend-${{ steps.meta.outputs.version_tag }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
        echo "- ë¹Œë“œ ì •ë³´: \`s3://${{ env.S3_BUCKET }}/backend/build-info/backend-${{ steps.meta.outputs.version_tag }}.json\`" >> $GITHUB_STEP_SUMMARY 