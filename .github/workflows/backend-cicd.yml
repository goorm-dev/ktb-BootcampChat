# ë°±ì—”ë“œ API CI/CD íŒŒì´í”„ë¼ì¸ 
# AMI ë¹Œë“œ ë° Auto Scaling Group ìžë™ ë°°í¬
name: Backend API CI/CD

on:
  push:
    branches: [ jacky ]
    paths:
      - 'backend/**'
      - 'scripts/**'
      - '.github/workflows/backend-cicd.yml'
  pull_request:
    branches: [ jacky ]
    paths:
      - 'backend/**'

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  AWS_REGION: ap-northeast-2
  BASE_AMI_ID: ami-0f5e205427609c732  # Amazon Linux 2023 ìµœì‹  AMI ID 
  INSTANCE_TYPE: t3.small
  # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
  VPC_ID: vpc-0cbb28aa7ecfee012
  SUBNET_ID: subnet-054215bf6c92eb539
  # GitHub ë ˆí¬ì§€í† ë¦¬ ì„¤ì •
  GITHUB_REPO: https://github.com/100-hours-a-week/8-ktb-chat.git
  GITHUB_BRANCH: jacky
  # ASG ê´€ë ¨ ì„¤ì • - ì‚¬ìš©ìž ìš”ì²­ì— ë”°ë¼ ë³€ê²½
  LAUNCH_TEMPLATE_NAME: pumati-load-test-backend-20250724073402992900000003
  ASG_NAME: pumati-load-test-backend-asg

jobs:
  # AMI ë¹Œë“œ ë° ASG ìžë™ ë°°í¬
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: AWS ìžê²©ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ë¹Œë“œ ë©”íƒ€ë°ì´í„° ìƒì„±
      id: meta
      run: |
        # Git ì»¤ë°‹ í•´ì‹œì˜ ì§§ì€ ë²„ì „ ìƒì„±
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        # íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„±
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # AMI ì´ë¦„ ìƒì„±
        AMI_NAME="ktb-chat-backend-jacky-${TIMESTAMP}-${SHORT_SHA}"
        
        echo "ami_name=${AMI_NAME}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

    - name: AMI ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      run: |
        echo "ðŸ“ AMI ì„¤ì •ì„ ìœ„í•œ User Data ìŠ¤í¬ë¦½íŠ¸ ìƒì„±..."
        
        cat > ami-setup.sh << EOF
        #!/bin/bash
        
        # ë¡œê·¸ ì„¤ì •
        exec > >(tee /var/log/ami-setup.log) 2>&1
        echo "=== AMI ì„¤ì • ì‹œìž‘: $(date) ==="
        
        # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
        echo "ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ì¤‘..."
        yum update -y
        
        # ê°œë°œ ë„êµ¬ ì„¤ì¹˜
        echo "ê°œë°œ ë„êµ¬ ì„¤ì¹˜ ì¤‘..."
        yum groupinstall -y "Development Tools"
        yum install -y git curl unzip
        
        # Node.js 18 ì„¤ì¹˜
        echo "Node.js 18 ì„¤ì¹˜ ì¤‘..."
        curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
        yum install -y nodejs
        
        # PM2 ì „ì—­ ì„¤ì¹˜
        echo "PM2 ì„¤ì¹˜ ì¤‘..."
        npm install -g pm2
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìž ìƒì„±
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìž ìƒì„±..."
        useradd -m -s /bin/bash appuser
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ì„¤ì •..."
        mkdir -p /opt/ktb-chat-backend
        chown appuser:appuser /opt/ktb-chat-backend
        
        # GitHubì—ì„œ ì½”ë“œ í´ë¡ 
        echo "GitHubì—ì„œ ë°±ì—”ë“œ ì½”ë“œ í´ë¡  ì¤‘..."
        cd /opt/ktb-chat-backend
        git clone -b ${{ env.GITHUB_BRANCH }} ${{ env.GITHUB_REPO }} .
        
        # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ì˜ì¡´ì„± ì„¤ì¹˜ (ìµœì í™”)
        cd backend
        echo "ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘... (ë³‘ë ¬ ì„¤ì¹˜ ë° ìºì‹œ í™œìš©)"
        # ë³‘ë ¬ ì„¤ì¹˜ ë° ìºì‹œ ìµœì í™”ë¡œ ì†ë„ í–¥ìƒ
        npm ci --production --silent --prefer-offline --no-audit &
        
        # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì˜ì¡´ì„± ì„¤ì¹˜í•˜ëŠ” ë™ì•ˆ ë‹¤ë¥¸ ì„¤ì • ìž‘ì—… ì§„í–‰
        cd ..
        
        # ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì • (ì˜ì¡´ì„± ì„¤ì¹˜ì™€ ë³‘ë ¬ ì§„í–‰)
        cat > /etc/logrotate.d/ktb-chat-backend << 'EOFLOGROTATE'
        /var/log/ktb-chat-backend*.log {
            daily
            rotate 30
            compress
            delaycompress
            missingok
            notifempty
            create 644 appuser appuser
            postrotate
                /usr/bin/pm2 reloadLogs
            endscript
        }
        EOFLOGROTATE
        
        # CloudWatch ì—ì´ì „íŠ¸ ì„¤ì¹˜ (ë³‘ë ¬)
        echo "CloudWatch ì—ì´ì „íŠ¸ ì„¤ì¹˜..."
        yum install -y amazon-cloudwatch-agent &
        
        # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        cat > /usr/local/bin/health-check.sh << 'EOFHEALTH'
        #!/bin/bash
        # ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
        curl -f http://localhost:5001/health || exit 1
        EOFHEALTH
        chmod +x /usr/local/bin/health-check.sh
        
        # ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ ëŒ€ê¸°
        cd backend
        wait  # npm ci ì™„ë£Œ ëŒ€ê¸°
        
        # ì†Œìœ ê¶Œ ë³€ê²½ ë° PM2 ë””ë ‰í† ë¦¬ ì„¤ì •
        chown -R appuser:appuser /opt/ktb-chat-backend
        
        # PM2 í™ˆ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
        mkdir -p /opt/ktb-chat-backend/.pm2
        chown -R appuser:appuser /opt/ktb-chat-backend/.pm2
        
        # ë¡œê·¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
        mkdir -p /var/log
        touch /var/log/ktb-chat-backend.log
        touch /var/log/ktb-chat-backend-out.log  
        touch /var/log/ktb-chat-backend-error.log
        chown appuser:appuser /var/log/ktb-chat-backend*.log
        
        # GitHub Secretsì—ì„œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
        cat > .env << 'EOFENV'
        ${{ secrets.ENV_BACKEND_DEV }}
        EOFENV
        
        # PM2 ecosystem íŒŒì¼ ìƒì„± (user/uid/gid ì„¤ì • ì œê±°)
        cat > ecosystem.config.js << 'EOFPM2'
        module.exports = {
          apps: [{
            name: 'ktb-chat-backend',
            script: 'server.js',
            cwd: '/opt/ktb-chat-backend/backend',
            instances: 1,
            exec_mode: 'fork',
            watch: false,
            max_memory_restart: '1G',
            env: {
              NODE_ENV: 'production',
              PORT: 5001
            },
            log_file: '/var/log/ktb-chat-backend.log',
            out_file: '/var/log/ktb-chat-backend-out.log',
            error_file: '/var/log/ktb-chat-backend-error.log',
            merge_logs: true,
            time: true,
            // user, uid, gid ì„¤ì • ì œê±° - PM2ê°€ ì´ë¯¸ appuserë¡œ ì‹¤í–‰ë¨
          }]
        };
        EOFPM2
        
        # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± (PM2 ecosystem íŒŒì¼ ì‚¬ìš©)
        cat > /etc/systemd/system/ktb-chat-backend.service << 'EOFSYSTEMD'
        [Unit]
        Description=KTB Chat Backend Application
        After=network.target
        
        [Service]
        Type=simple
        User=appuser
        Group=appuser
        WorkingDirectory=/opt/ktb-chat-backend/backend
        # ecosystem.config.js íŒŒì¼ ì‚¬ìš©ìœ¼ë¡œ user ê¶Œí•œ ë¬¸ì œ í•´ê²°
        ExecStart=/usr/bin/pm2 start ecosystem.config.js --no-daemon
        ExecReload=/usr/bin/pm2 reload ecosystem.config.js
        ExecStop=/usr/bin/pm2 stop ecosystem.config.js
        Restart=always
        RestartSec=10
        StandardOutput=syslog
        StandardError=syslog
        SyslogIdentifier=ktb-chat-backend
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        Environment=NODE_ENV=production
        Environment=PM2_HOME=/opt/ktb-chat-backend/.pm2
        
        [Install]
        WantedBy=multi-user.target
        EOFSYSTEMD
        
        # systemd ì„œë¹„ìŠ¤ í™œì„±í™” (ë¶€íŒ… ì‹œ ìžë™ ì‹œìž‘)
        systemctl daemon-reload
        systemctl enable ktb-chat-backend.service
        
        # ë°±ê·¸ë¼ìš´ë“œ ìž‘ì—…ë“¤ ì™„ë£Œ ëŒ€ê¸°
        wait  # ëª¨ë“  ë°±ê·¸ë¼ìš´ë“œ ìž‘ì—… ì™„ë£Œ ëŒ€ê¸°
        
        # API ì„œë²„ AMI ì„¤ì • ì™„ë£Œ í‘œì‹œ
        echo "=== API ì„œë²„ AMI ì„¤ì • ì™„ë£Œ: $(date) ==="
        echo "GitHub ë ˆí¬ì§€í† ë¦¬: ${{ env.GITHUB_REPO }}"
        echo "ë¸Œëžœì¹˜: ${{ env.GITHUB_BRANCH }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        
        # ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸
        touch /tmp/ami-setup-complete
        EOF
        
        # ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        chmod +x ami-setup.sh

    - name: ê¸°ë³¸ ë³´ì•ˆ ê·¸ë£¹ í™•ì¸
      id: security-group
      run: |
        echo "ðŸ”’ VPC ê¸°ë³¸ ë³´ì•ˆ ê·¸ë£¹ ì‚¬ìš©..."
        
        # VPCì˜ ê¸°ë³¸ ë³´ì•ˆ ê·¸ë£¹ ì°¾ê¸°
        DEFAULT_SG_ID=$(aws ec2 describe-security-groups \
          --filters "Name=group-name,Values=default" "Name=vpc-id,Values=${{ env.VPC_ID }}" \
          --query 'SecurityGroups[0].GroupId' \
          --output text)
        
        if [[ "$DEFAULT_SG_ID" == "None" || "$DEFAULT_SG_ID" == "" ]]; then
          echo "âŒ VPC ê¸°ë³¸ ë³´ì•ˆ ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        echo "âœ… VPC ê¸°ë³¸ ë³´ì•ˆ ê·¸ë£¹ ì‚¬ìš©: ${DEFAULT_SG_ID}"
        echo "â„¹ï¸ ê¸°ë³¸ ë³´ì•ˆ ê·¸ë£¹ì´ë¯€ë¡œ ë³„ë„ ì •ë¦¬ ë¶ˆí•„ìš”"
        
        # ê¸°ë³¸ ë³´ì•ˆ ê·¸ë£¹ì— í•„ìš”í•œ ì•„ì›ƒë°”ìš´ë“œ ê·œì¹™ì´ ìžˆëŠ”ì§€ í™•ì¸ (ë³´í†µ ê¸°ë³¸ê°’ìœ¼ë¡œ ëª¨ë“  ì•„ì›ƒë°”ìš´ë“œ í—ˆìš©)
        echo "ðŸ“‹ ë³´ì•ˆ ê·¸ë£¹ ê·œì¹™ í™•ì¸ ì¤‘..."
        aws ec2 describe-security-groups --group-ids ${DEFAULT_SG_ID} --query 'SecurityGroups[0].{Inbound:IpPermissions,Outbound:IpPermissionsEgress}'
        
        echo "security_group_id=${DEFAULT_SG_ID}" >> $GITHUB_OUTPUT

    - name: EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° AMI ë¹Œë“œ
      id: create-instance
      run: |
        echo "ðŸ–¥ï¸ AMI ë¹Œë“œìš© EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘..."
        
        # EC2 ì¸ìŠ¤í„´ìŠ¤ ì‹¤í–‰ (VPC ë° ì„œë¸Œë„· ì§€ì •)
        INSTANCE_ID=$(aws ec2 run-instances \
          --image-id ${{ env.BASE_AMI_ID }} \
          --instance-type ${{ env.INSTANCE_TYPE }} \
          --subnet-id ${{ env.SUBNET_ID }} \
          --security-group-ids ${{ steps.security-group.outputs.security_group_id }} \
          --associate-public-ip-address \
          --user-data file://ami-setup.sh \
          --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=AMI-Build-${{ steps.meta.outputs.ami_name }}},{Key=Purpose,Value=AMI-Build},{Key=Application,Value=ktb-chat-backend}]' \
          --query 'Instances[0].InstanceId' \
          --output text)
        
        echo "instance_id=${INSTANCE_ID}" >> $GITHUB_OUTPUT
        echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ë¨: ${INSTANCE_ID}"
        
        # ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        echo "â³ ì¸ìŠ¤í„´ìŠ¤ ë¶€íŒ… ë° ì„¤ì • ëŒ€ê¸° ì¤‘..."
        aws ec2 wait instance-running --instance-ids ${INSTANCE_ID}
        
        # ìµœì í™”ëœ ëŒ€ê¸° ì‹œê°„ (ë³‘ë ¬ ì„¤ì¹˜ë¡œ ì‹œê°„ ë‹¨ì¶•)
        echo "ðŸ“¦ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜ ì¤‘... (ì•½ 3ë¶„ ì†Œìš”)"
        sleep 180
        
        echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ì„¤ì • ì™„ë£Œ"

    - name: AMI ìƒì„±
      id: create-ami
      run: |
        echo "ðŸ“¸ AMI ìƒì„± ì¤‘..."
        
        # ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€
        echo "ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€ ì¤‘..."
        aws ec2 stop-instances --instance-ids ${{ steps.create-instance.outputs.instance_id }}
        aws ec2 wait instance-stopped --instance-ids ${{ steps.create-instance.outputs.instance_id }}
        
        # AMI ìƒì„±
        echo "AMI ìŠ¤ëƒ…ìƒ· ìƒì„± ì¤‘..."
        AMI_ID=$(aws ec2 create-image \
          --instance-id ${{ steps.create-instance.outputs.instance_id }} \
          --name "${{ steps.meta.outputs.ami_name }}" \
          --description "KTB Chat Backend API AMI - jacky branch - Built on $(date)" \
          --no-reboot \
          --tag-specifications 'ResourceType=image,Tags=[{Key=Name,Value=${{ steps.meta.outputs.ami_name }}},{Key=Branch,Value=jacky},{Key=Application,Value=ktb-chat-backend},{Key=Environment,Value=development},{Key=BuildTimestamp,Value=${{ steps.meta.outputs.timestamp }}}]' \
          --query 'ImageId' \
          --output text)
        
        echo "ami_id=${AMI_ID}" >> $GITHUB_OUTPUT
        echo "âœ… AMI ìƒì„±ë¨: ${AMI_ID}"
        
        # AMI ì‚¬ìš© ê°€ëŠ¥í•  ë•Œê¹Œì§€ ëŒ€ê¸°
        echo "â³ AMI ìƒì„± ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
        aws ec2 wait image-available --image-ids ${AMI_ID}
        
        echo "ðŸŽ‰ AMI ìƒì„± ì™„ë£Œ: ${AMI_ID}"

    - name: Launch Template ì—…ë°ì´íŠ¸
      id: update-template
      run: |
        echo "ðŸš€ Launch Template ì—…ë°ì´íŠ¸ ì¤‘..."
        
        # ê¸°ì¡´ Launch Template í™•ì¸
        if aws ec2 describe-launch-templates --launch-template-names ${{ env.LAUNCH_TEMPLATE_NAME }} >/dev/null 2>&1; then
          echo "ê¸°ì¡´ Launch Template ë°œê²¬: ${{ env.LAUNCH_TEMPLATE_NAME }}"
          
          # ê¸°ì¡´ í…œí”Œë¦¿ì˜ ìµœì‹  ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          echo "ê¸°ì¡´ í…œí”Œë¦¿ ì„¤ì • ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          EXISTING_CONFIG=$(aws ec2 describe-launch-template-versions \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --versions '$Latest' \
            --query 'LaunchTemplateVersions[0].LaunchTemplateData' \
            --output json)
          
          # ê¸°ì¡´ ì„¤ì •ì—ì„œ AMI IDë§Œ ì—…ë°ì´íŠ¸
          echo "ê¸°ì¡´ ì„¤ì •ì„ ìœ ì§€í•˜ë©´ì„œ AMI IDë§Œ ì—…ë°ì´íŠ¸..."
          UPDATED_CONFIG=$(echo "$EXISTING_CONFIG" | jq --arg ami_id "${{ steps.create-ami.outputs.ami_id }}" '.ImageId = $ami_id')
          
          # ìƒˆ ë²„ì „ ìƒì„± (ê¸°ì¡´ ì„¤ì • + ìƒˆ AMI ID)
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --source-version '$Latest' \
            --launch-template-data "$UPDATED_CONFIG" \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)
          
          echo "template_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Launch Template ìƒˆ ë²„ì „ ìƒì„±ë¨: ${NEW_VERSION} (AMI IDë§Œ ì—…ë°ì´íŠ¸)"
          
          # ê¸°ë³¸ ë²„ì „ìœ¼ë¡œ ì„¤ì •
          aws ec2 modify-launch-template \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --default-version ${NEW_VERSION}
          
          echo "âœ… Launch Template ê¸°ë³¸ ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "â„¹ï¸ ê¸°ì¡´ í…œí”Œë¦¿ì˜ ëª¨ë“  ì„¤ì •ì´ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤ (AMI ID ì œì™¸)"
          
        else
          echo "âŒ Launch Templateì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${{ env.LAUNCH_TEMPLATE_NAME }}"
          echo "í…œí”Œë¦¿ì´ ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
          echo "ë¨¼ì € AWS ì½˜ì†”ì—ì„œ í•´ë‹¹ í…œí”Œë¦¿ì„ ìƒì„±í•˜ê±°ë‚˜ í…œí”Œë¦¿ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          exit 1
        fi

    - name: Auto Scaling Group ì—…ë°ì´íŠ¸ ë° ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨
      id: update-asg
      run: |
        echo "ðŸ“ˆ Auto Scaling Group ì—…ë°ì´íŠ¸ ë° ì¸ìŠ¤í„´ìŠ¤ êµì²´ ì¤‘..."
        
        # ASG ì¡´ìž¬ í™•ì¸
        if aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names ${{ env.ASG_NAME }} >/dev/null 2>&1; then
          echo "ê¸°ì¡´ ASG ë°œê²¬: ${{ env.ASG_NAME }}"
          
          # ASG Launch Template ì—…ë°ì´íŠ¸
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --launch-template LaunchTemplateName=${{ env.LAUNCH_TEMPLATE_NAME }},Version='$Latest'
          
          echo "âœ… ASG Launch Template ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          
          # ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì‹œìž‘
          echo "ðŸ”„ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì‹œìž‘ ì¤‘..."
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --preferences '{
              "InstanceWarmup": 300,
              "MinHealthyPercentage": 50,
              "CheckpointPercentages": [50, 100],
              "CheckpointDelay": 600,
              "SkipMatching": false
            }' \
            --query 'InstanceRefreshId' \
            --output text)
          
          echo "refresh_id=${REFRESH_ID}" >> $GITHUB_OUTPUT
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì‹œìž‘ë¨: ${REFRESH_ID}"
          
          # ìƒˆë¡œê³ ì¹¨ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§
          echo "â³ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§ ì¤‘..."
          
          while true; do
            # ìƒˆë¡œê³ ì¹¨ ìƒíƒœ í™•ì¸
            REFRESH_STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ env.ASG_NAME }} \
              --instance-refresh-ids ${REFRESH_ID} \
              --query 'InstanceRefreshes[0].Status' \
              --output text)
            
            # ì§„í–‰ë¥  í™•ì¸
            PERCENTAGE=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ env.ASG_NAME }} \
              --instance-refresh-ids ${REFRESH_ID} \
              --query 'InstanceRefreshes[0].PercentageComplete' \
              --output text)
            
            echo "í˜„ìž¬ ìƒíƒœ: ${REFRESH_STATUS}, ì§„í–‰ë¥ : ${PERCENTAGE}%"
            
            # ì™„ë£Œ ìƒíƒœ í™•ì¸
            if [[ "$REFRESH_STATUS" == "Successful" ]]; then
              echo "ðŸŽ‰ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ!"
              break
            elif [[ "$REFRESH_STATUS" == "Failed" || "$REFRESH_STATUS" == "Cancelled" ]]; then
              echo "âŒ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${REFRESH_STATUS}"
              
              # ì‹¤íŒ¨ ì›ì¸ ì¡°íšŒ
              FAILURE_REASON=$(aws autoscaling describe-instance-refreshes \
                --auto-scaling-group-name ${{ env.ASG_NAME }} \
                --instance-refresh-ids ${REFRESH_ID} \
                --query 'InstanceRefreshes[0].StatusReason' \
                --output text)
              
              echo "ì‹¤íŒ¨ ì›ì¸: ${FAILURE_REASON}"
              exit 1
            elif [[ "$REFRESH_STATUS" == "InProgress" ]]; then
              echo "ê³„ì† ì§„í–‰ ì¤‘... 30ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸í•©ë‹ˆë‹¤."
              sleep 30
            else
              echo "ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ: ${REFRESH_STATUS}"
              sleep 30
            fi
          done
          
        else
          echo "âŒ ASGê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${{ env.ASG_NAME }}"
          echo "í…œí”Œë¦¿ì€ ì—…ë°ì´íŠ¸ë˜ì—ˆì§€ë§Œ ASGê°€ ì—†ìœ¼ë¯€ë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          echo "AWS ì½˜ì†”ì—ì„œ ASGë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
          exit 1
        fi

    - name: ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
      if: always()
      run: |
        echo "ðŸ§¹ ë¹Œë“œìš© ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬ ì¤‘..."
        
        if [[ -n "${{ steps.create-instance.outputs.instance_id }}" ]]; then
          # ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ
          aws ec2 terminate-instances --instance-ids ${{ steps.create-instance.outputs.instance_id }}
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œë¨: ${{ steps.create-instance.outputs.instance_id }}"
        fi
        
        # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f ami-setup.sh

    - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
      if: success()
      run: |
        echo "## ðŸŽ‰ ë°±ì—”ë“œ API CI/CD ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ AMI ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **AMI ID**: \`${{ steps.create-ami.outputs.ami_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **AMI ì´ë¦„**: \`${{ steps.meta.outputs.ami_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëžœì¹˜**: jacky" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¹Œë“œ ì‹œê°„**: ${{ steps.meta.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ ë¹Œë“œ í™˜ê²½ ì„¤ì •" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub ë ˆí¬**: ${{ env.GITHUB_REPO }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëžœì¹˜**: ${{ env.GITHUB_BRANCH }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë°°í¬ ëŒ€ìƒ**: Load Test í™˜ê²½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **Launch Template**: \`${{ env.LAUNCH_TEMPLATE_NAME }}\` (ë²„ì „ ${{ steps.update-template.outputs.template_version }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Auto Scaling Group**: \`${{ env.ASG_NAME }}\` (ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ)" >> $GITHUB_STEP_SUMMARY
        echo "- **ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ID**: \`${{ steps.update-asg.outputs.refresh_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š ëª¨ë‹ˆí„°ë§" >> $GITHUB_STEP_SUMMARY
        echo "- ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸: 5001" >> $GITHUB_STEP_SUMMARY
        echo "- í—¬ìŠ¤ì²´í¬: \`/health\` ì—”ë“œí¬ì¸íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "- ë¡œê·¸ ìœ„ì¹˜: \`/var/log/ktb-chat-backend*.log\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ ë°°í¬ ì£¼ì˜ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        echo "- ëª¨ë“  ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒˆ AMIë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
        echo "- ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì„œë¹„ìŠ¤ ê°€ìš©ì„±ì´ 50% ì´ìƒ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
        echo "- ìƒˆ ì¸ìŠ¤í„´ìŠ¤ëŠ” 5ë¶„ì˜ ì›Œë°ì—… ì‹œê°„ì„ ê±°ì³¤ìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
        echo "- MongoDB, Redis ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”" >> $GITHUB_STEP_SUMMARY
