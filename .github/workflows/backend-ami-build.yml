# ë°±ì—”ë“œ ASGìš© ì»¤ìŠ¤í…€ AMI ìƒì„± íŒŒì´í”„ë¼ì¸ (ê°œë°œ í™˜ê²½)
# ë°±ì—”ë“œ ì½”ë“œë¥¼ GitHubì—ì„œ ì§ì ‘ cloneí•˜ì—¬ systemdë¡œ ì‹¤í–‰í•˜ëŠ” AMI ìƒì„± ë° ASG ì—…ë°ì´íŠ¸
name: Backend AMI Build (Dev)

on:
  push:
    branches: [ jacky ]
    paths:
      - 'backend/**'
      - 'scripts/**'
      - '.github/workflows/backend-ami-build.yml'
  pull_request:
    branches: [ jacky ]
    paths:
      - 'backend/**'

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  AWS_REGION: ap-northeast-2
  BASE_AMI_ID: ami-0f5e205427609c732  # Amazon Linux 2023 ìµœì‹  AMI ID
  INSTANCE_TYPE: t3.small
  # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
  VPC_ID: vpc-0cbb28aa7ecfee012
  SUBNET_ID: subnet-054215bf6c92eb539
  # GitHub ë ˆí¬ì§€í† ë¦¬ ì„¤ì •
  GITHUB_REPO: https://github.com/100-hours-a-week/8-ktb-chat.git
  GITHUB_BRANCH: jacky
  # ASG ê´€ë ¨ ì„¤ì •
  LAUNCH_TEMPLATE_NAME: ktb-chat-backend-template
  ASG_NAME: ktb-chat-backend-asg

jobs:
  # AMI ìƒì„± ë° ë°±ì—”ë“œ ë°°í¬
  build-ami:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: AWS ìžê²©ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ë¹Œë“œ ë©”íƒ€ë°ì´í„° ìƒì„±
      id: meta
      run: |
        # Git ì»¤ë°‹ í•´ì‹œì˜ ì§§ì€ ë²„ì „ ìƒì„±
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        # íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„±
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # AMI ì´ë¦„ ìƒì„±
        AMI_NAME="ktb-chat-backend-jacky-${TIMESTAMP}-${SHORT_SHA}"
        
        echo "ami_name=${AMI_NAME}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

    - name: AMI ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      run: |
        echo "ðŸ“ AMI ì„¤ì •ì„ ìœ„í•œ User Data ìŠ¤í¬ë¦½íŠ¸ ìƒì„±..."
        
        cat > ami-setup.sh << EOF
        #!/bin/bash
        
        # ë¡œê·¸ ì„¤ì •
        exec > >(tee /var/log/ami-setup.log) 2>&1
        echo "=== AMI ì„¤ì • ì‹œìž‘: $(date) ==="
        
        # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
        echo "ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ì¤‘..."
        yum update -y
        
        # ê°œë°œ ë„êµ¬ ì„¤ì¹˜
        echo "ê°œë°œ ë„êµ¬ ì„¤ì¹˜ ì¤‘..."
        yum groupinstall -y "Development Tools"
        yum install -y git curl unzip
        
        # Node.js 18 ì„¤ì¹˜
        echo "Node.js 18 ì„¤ì¹˜ ì¤‘..."
        curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
        yum install -y nodejs
        
        # PM2 ì „ì—­ ì„¤ì¹˜
        echo "PM2 ì„¤ì¹˜ ì¤‘..."
        npm install -g pm2
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìž ìƒì„±
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìž ìƒì„±..."
        useradd -m -s /bin/bash appuser
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ì„¤ì •..."
        mkdir -p /opt/ktb-chat-backend
        chown appuser:appuser /opt/ktb-chat-backend
        
        # GitHubì—ì„œ ì½”ë“œ í´ë¡ 
        echo "GitHubì—ì„œ ë°±ì—”ë“œ ì½”ë“œ í´ë¡  ì¤‘..."
        cd /opt/ktb-chat-backend
        git clone -b ${{ env.GITHUB_BRANCH }} ${{ env.GITHUB_REPO }} .
        
        # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ì˜ì¡´ì„± ì„¤ì¹˜
        cd backend
        echo "ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
        npm ci --production
        
        # ì†Œìœ ê¶Œ ë³€ê²½
        chown -R appuser:appuser /opt/ktb-chat-backend
        
        # GitHub Secretsì—ì„œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
        cat > .env << 'EOFENV'
        ${{ secrets.ENV_BACKEND_DEV }}
        EOFENV
        
        # PM2 ecosystem íŒŒì¼ ìƒì„±
        cat > ecosystem.config.js << 'EOFPM2'
        module.exports = {
          apps: [{
            name: 'ktb-chat-backend',
            script: 'server.js',
            cwd: '/opt/ktb-chat-backend/backend',
            user: 'appuser',
            instances: 1,
            exec_mode: 'cluster',
            watch: false,
            max_memory_restart: '1G',
            env: {
              NODE_ENV: 'production',
              PORT: 5000
            },
            log_file: '/var/log/ktb-chat-backend.log',
            out_file: '/var/log/ktb-chat-backend-out.log',
            error_file: '/var/log/ktb-chat-backend-error.log',
            merge_logs: true,
            time: true
          }]
        };
        EOFPM2
        
        # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
        cat > /etc/systemd/system/ktb-chat-backend.service << 'EOFSYSTEMD'
        [Unit]
        Description=KTB Chat Backend Application
        After=network.target
        
        [Service]
        Type=forking
        User=appuser
        WorkingDirectory=/opt/ktb-chat-backend
        ExecStart=/usr/bin/pm2 start ecosystem.config.js --no-daemon
        ExecReload=/usr/bin/pm2 reload ecosystem.config.js
        ExecStop=/usr/bin/pm2 kill
        Restart=always
        RestartSec=10
        StandardOutput=syslog
        StandardError=syslog
        SyslogIdentifier=ktb-chat-backend
        
        [Install]
        WantedBy=multi-user.target
        EOFSYSTEMD
        
        # systemd ì„œë¹„ìŠ¤ í™œì„±í™” (ë¶€íŒ… ì‹œ ìžë™ ì‹œìž‘)
        systemctl daemon-reload
        systemctl enable ktb-chat-backend.service
        
        # ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •
        cat > /etc/logrotate.d/ktb-chat-backend << 'EOFLOGROTATE'
        /var/log/ktb-chat-backend*.log {
            daily
            rotate 30
            compress
            delaycompress
            missingok
            notifempty
            create 644 appuser appuser
            postrotate
                /usr/bin/pm2 reloadLogs
            endscript
        }
        EOFLOGROTATE
        
        # CloudWatch ì—ì´ì „íŠ¸ ì„¤ì¹˜ (ì„ íƒì‚¬í•­)
        echo "CloudWatch ì—ì´ì „íŠ¸ ì„¤ì¹˜..."
        yum install -y amazon-cloudwatch-agent
        
        # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        cat > /usr/local/bin/health-check.sh << 'EOFHEALTH'
        #!/bin/bash
        # ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
        curl -f http://localhost:5000/health || exit 1
        EOFHEALTH
        chmod +x /usr/local/bin/health-check.sh
        
        # ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ í‘œì‹œ
        echo "=== ê°œë°œ í™˜ê²½ AMI ì„¤ì • ì™„ë£Œ: $(date) ==="
        echo "GitHub ë ˆí¬ì§€í† ë¦¬: ${{ env.GITHUB_REPO }}"
        echo "ë¸Œëžœì¹˜: ${{ env.GITHUB_BRANCH }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        
        # ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸
        touch /tmp/ami-setup-complete
        EOF
        
        # ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        chmod +x ami-setup.sh

    - name: ë³´ì•ˆ ê·¸ë£¹ ìƒì„± ë˜ëŠ” í™•ì¸
      id: security-group
      run: |
        echo "ðŸ”’ ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • ì¤‘..."
        
        # AMI ë¹Œë“œìš© ë³´ì•ˆ ê·¸ë£¹ ì´ë¦„
        SG_NAME="ktb-chat-ami-build-sg"
        
        # ê¸°ì¡´ ë³´ì•ˆ ê·¸ë£¹ í™•ì¸
        SG_ID=$(aws ec2 describe-security-groups \
          --filters "Name=group-name,Values=${SG_NAME}" "Name=vpc-id,Values=${{ env.VPC_ID }}" \
          --query 'SecurityGroups[0].GroupId' \
          --output text 2>/dev/null || echo "None")
        
        if [[ "$SG_ID" == "None" || "$SG_ID" == "" ]]; then
          echo "ìƒˆ ë³´ì•ˆ ê·¸ë£¹ ìƒì„± ì¤‘..."
          
          # ë³´ì•ˆ ê·¸ë£¹ ìƒì„±
          SG_ID=$(aws ec2 create-security-group \
            --group-name "${SG_NAME}" \
            --description "Security group for KTB Chat AMI build instances" \
            --vpc-id ${{ env.VPC_ID }} \
            --query 'GroupId' \
            --output text)
          
          # ì¸ë°”ìš´ë“œ ê·œì¹™ ì¶”ê°€ (SSH ì ‘ê·¼ìš© - ì „ì²´ ì¸í„°ë„·ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)
          aws ec2 authorize-security-group-ingress \
            --group-id ${SG_ID} \
            --protocol tcp \
            --port 22 \
            --cidr 0.0.0.0/0
          
          # HTTP ì ‘ê·¼ í—ˆìš© (íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œìš©)
          aws ec2 authorize-security-group-ingress \
            --group-id ${SG_ID} \
            --protocol tcp \
            --port 80 \
            --cidr 0.0.0.0/0
          
          # HTTPS ì ‘ê·¼ í—ˆìš© (íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œìš©)
          aws ec2 authorize-security-group-ingress \
            --group-id ${SG_ID} \
            --protocol tcp \
            --port 443 \
            --cidr 0.0.0.0/0
          
          echo "âœ… ìƒˆ ë³´ì•ˆ ê·¸ë£¹ ìƒì„±ë¨: ${SG_ID}"
        else
          echo "âœ… ê¸°ì¡´ ë³´ì•ˆ ê·¸ë£¹ ì‚¬ìš©: ${SG_ID}"
        fi
        
        echo "security_group_id=${SG_ID}" >> $GITHUB_OUTPUT

    - name: EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° AMI ë¹Œë“œ
      id: create-instance
      run: |
        echo "ðŸ–¥ï¸ AMI ë¹Œë“œìš© EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘..."
        
        # EC2 ì¸ìŠ¤í„´ìŠ¤ ì‹¤í–‰ (VPC ë° ì„œë¸Œë„· ì§€ì •)
        INSTANCE_ID=$(aws ec2 run-instances \
          --image-id ${{ env.BASE_AMI_ID }} \
          --instance-type ${{ env.INSTANCE_TYPE }} \
          --subnet-id ${{ env.SUBNET_ID }} \
          --security-group-ids ${{ steps.security-group.outputs.security_group_id }} \
          --associate-public-ip-address \
          --user-data file://ami-setup.sh \
          --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=AMI-Build-${{ steps.meta.outputs.ami_name }}},{Key=Purpose,Value=AMI-Build},{Key=Application,Value=ktb-chat-backend}]' \
          --query 'Instances[0].InstanceId' \
          --output text)
        
        echo "instance_id=${INSTANCE_ID}" >> $GITHUB_OUTPUT
        echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ë¨: ${INSTANCE_ID}"
        
        # ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        echo "â³ ì¸ìŠ¤í„´ìŠ¤ ë¶€íŒ… ë° ì„¤ì • ëŒ€ê¸° ì¤‘..."
        aws ec2 wait instance-running --instance-ids ${INSTANCE_ID}
        
        # ì¶”ê°€ ëŒ€ê¸° ì‹œê°„ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜ ì™„ë£Œë¥¼ ìœ„í•´)
        echo "ðŸ“¦ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜ ì¤‘... (ì•½ 7ë¶„ ì†Œìš”)"
        sleep 420
        
        echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ì„¤ì • ì™„ë£Œ"

    - name: AMI ìƒì„±
      id: create-ami
      run: |
        echo "ðŸ“¸ AMI ìƒì„± ì¤‘..."
        
        # ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€
        echo "ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€ ì¤‘..."
        aws ec2 stop-instances --instance-ids ${{ steps.create-instance.outputs.instance_id }}
        aws ec2 wait instance-stopped --instance-ids ${{ steps.create-instance.outputs.instance_id }}
        
        # AMI ìƒì„±
        echo "AMI ìŠ¤ëƒ…ìƒ· ìƒì„± ì¤‘..."
        AMI_ID=$(aws ec2 create-image \
          --instance-id ${{ steps.create-instance.outputs.instance_id }} \
          --name "${{ steps.meta.outputs.ami_name }}" \
          --description "KTB Chat Backend AMI - jacky branch (Dev) - Built on $(date)" \
          --no-reboot \
          --tag-specifications 'ResourceType=image,Tags=[{Key=Name,Value=${{ steps.meta.outputs.ami_name }}},{Key=Branch,Value=jacky},{Key=Application,Value=ktb-chat-backend},{Key=Environment,Value=development},{Key=BuildTimestamp,Value=${{ steps.meta.outputs.timestamp }}}]' \
          --query 'ImageId' \
          --output text)
        
        echo "ami_id=${AMI_ID}" >> $GITHUB_OUTPUT
        echo "âœ… AMI ìƒì„±ë¨: ${AMI_ID}"
        
        # AMI ì‚¬ìš© ê°€ëŠ¥í•  ë•Œê¹Œì§€ ëŒ€ê¸°
        echo "â³ AMI ìƒì„± ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
        aws ec2 wait image-available --image-ids ${AMI_ID}
        
        echo "ðŸŽ‰ AMI ìƒì„± ì™„ë£Œ: ${AMI_ID}"

    - name: Launch Template ì—…ë°ì´íŠ¸
      id: update-template
      run: |
        echo "ðŸš€ Launch Template ì—…ë°ì´íŠ¸ ì¤‘..."
        
        # ê¸°ì¡´ Launch Template í™•ì¸
        if aws ec2 describe-launch-templates --launch-template-names ${{ env.LAUNCH_TEMPLATE_NAME }} >/dev/null 2>&1; then
          echo "ê¸°ì¡´ Launch Template ë°œê²¬: ${{ env.LAUNCH_TEMPLATE_NAME }}"
          
          # ìƒˆ ë²„ì „ ìƒì„±
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --source-version '$Latest' \
            --launch-template-data '{
              "ImageId": "${{ steps.create-ami.outputs.ami_id }}",
              "TagSpecifications": [
                {
                  "ResourceType": "instance",
                  "Tags": [
                    {"Key": "Name", "Value": "ktb-chat-backend-dev-instance"},
                    {"Key": "Application", "Value": "ktb-chat-backend"},
                    {"Key": "Environment", "Value": "development"},
                    {"Key": "Branch", "Value": "jacky"},
                    {"Key": "AMI-Version", "Value": "${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.short_sha }}"}
                  ]
                }
              ]
            }' \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)
          
          echo "template_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Launch Template ìƒˆ ë²„ì „ ìƒì„±ë¨: ${NEW_VERSION}"
          
          # ê¸°ë³¸ ë²„ì „ìœ¼ë¡œ ì„¤ì •
          aws ec2 modify-launch-template \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --default-version ${NEW_VERSION}
          
          echo "âœ… Launch Template ê¸°ë³¸ ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          
        else
          echo "Launch Templateì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤..."
          
          # ìƒˆ Launch Template ìƒì„± (ê°œë°œ í™˜ê²½ìš© ì„¤ì •)
          aws ec2 create-launch-template \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --launch-template-data '{
              "ImageId": "${{ steps.create-ami.outputs.ami_id }}",
              "InstanceType": "t3.small",
              "Monitoring": {
                "Enabled": true
              },
              "TagSpecifications": [
                {
                  "ResourceType": "instance",
                  "Tags": [
                    {"Key": "Name", "Value": "ktb-chat-backend-dev-instance"},
                    {"Key": "Application", "Value": "ktb-chat-backend"},
                    {"Key": "Environment", "Value": "development"},
                    {"Key": "Branch", "Value": "jacky"},
                    {"Key": "AMI-Version", "Value": "${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.short_sha }}"}
                  ]
                }
              ]
            }'
          
          echo "template_version=1" >> $GITHUB_OUTPUT
          echo "âœ… ìƒˆ Launch Template ìƒì„± ì™„ë£Œ"
        fi

    - name: Auto Scaling Group ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­)
      run: |
        echo "ðŸ“ˆ Auto Scaling Group ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘..."
        
        # ASG ì¡´ìž¬ í™•ì¸
        if aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names ${{ env.ASG_NAME }} >/dev/null 2>&1; then
          echo "ê¸°ì¡´ ASG ë°œê²¬: ${{ env.ASG_NAME }}"
          
          # ASG Launch Template ì—…ë°ì´íŠ¸
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --launch-template LaunchTemplateName=${{ env.LAUNCH_TEMPLATE_NAME }},Version='$Latest'
          
          echo "âœ… ASG Launch Template ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          
          # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì¦‰ì‹œ ì¸ìŠ¤í„´ìŠ¤ êµì²´í•˜ì§€ ì•ŠìŒ
          echo "â„¹ï¸ ê°œë°œ í™˜ê²½ì´ë¯€ë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ì„ ìžë™ìœ¼ë¡œ ì‹œìž‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "í•„ìš”ì‹œ AWS ì½˜ì†”ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ì„ ì‹œìž‘í•˜ì„¸ìš”."
          
        else
          echo "âš ï¸ ASGê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${{ env.ASG_NAME }}"
          echo "í•„ìš”ì‹œ AWS ì½˜ì†”ì—ì„œ ASGë¥¼ ìƒì„±í•œ í›„ Launch Templateì„ ì‚¬ìš©í•˜ì„¸ìš”."
        fi

    - name: ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
      if: always()
      run: |
        echo "ðŸ§¹ ë¹Œë“œìš© ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬ ì¤‘..."
        
        if [[ -n "${{ steps.create-instance.outputs.instance_id }}" ]]; then
          # ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ
          aws ec2 terminate-instances --instance-ids ${{ steps.create-instance.outputs.instance_id }}
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œë¨: ${{ steps.create-instance.outputs.instance_id }}"
        fi
        
        # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f ami-setup.sh

    - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
      if: success()
      run: |
        echo "## ðŸŽ‰ ë°±ì—”ë“œ AMI ë¹Œë“œ ì™„ë£Œ (ê°œë°œ í™˜ê²½)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ AMI ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **AMI ID**: \`${{ steps.create-ami.outputs.ami_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **AMI ì´ë¦„**: \`${{ steps.meta.outputs.ami_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëžœì¹˜**: jacky" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¹Œë“œ ì‹œê°„**: ${{ steps.meta.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ ê°œë°œ í™˜ê²½ ì„¤ì •" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub ë ˆí¬**: ${{ env.GITHUB_REPO }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëžœì¹˜**: ${{ env.GITHUB_BRANCH }}" >> $GITHUB_STEP_SUMMARY
        echo "- **í™˜ê²½**: ê°œë°œìš© (ê¸°ë³¸ ì„¤ì • í¬í•¨)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **Launch Template**: \`${{ env.LAUNCH_TEMPLATE_NAME }}\` (ë²„ì „ ${{ steps.update-template.outputs.template_version }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Auto Scaling Group**: \`${{ env.ASG_NAME }}\` (ìžë™ êµì²´ ë¹„í™œì„±í™”)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š ëª¨ë‹ˆí„°ë§" >> $GITHUB_STEP_SUMMARY
        echo "- ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸: 5000" >> $GITHUB_STEP_SUMMARY
        echo "- í—¬ìŠ¤ì²´í¬: \`/health\` ì—”ë“œí¬ì¸íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "- ë¡œê·¸ ìœ„ì¹˜: \`/var/log/ktb-chat-backend*.log\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ ê°œë°œ í™˜ê²½ ì£¼ì˜ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        echo "- ê¸°ë³¸ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìžˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
        echo "- í”„ë¡œë•ì…˜ ì‚¬ìš© ì „ ë³´ì•ˆ ì„¤ì •ì„ ë³€ê²½í•˜ì„¸ìš”" >> $GITHUB_STEP_SUMMARY
        echo "- MongoDB, RedisëŠ” ë³„ë„ë¡œ ì„¤ì¹˜/ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
