# ë°±ì—”ë“œ ASGìš© ì»¤ìŠ¤í…€ AMI ìƒì„± íŒŒì´í”„ë¼ì¸
# ë°±ì—”ë“œ ì½”ë“œë¥¼ ì§ì ‘ ë°°í¬í•˜ì—¬ systemdë¡œ ì‹¤í–‰í•˜ëŠ” AMI ìƒì„± ë° ASG ì—…ë°ì´íŠ¸
name: Backend AMI Build

on:
  push:
    branches: [ jacky ]
    paths:
      - 'backend/**'
      - 'scripts/**'
      - '.github/workflows/backend-ami-build.yml'
  pull_request:
    branches: [ jacky ]
    paths:
      - 'backend/**'

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  AWS_REGION: ap-northeast-2
  BASE_AMI_ID: ami-0f5e205427609c732  # Amazon Linux 2023 ìµœì‹  AMI ID
  INSTANCE_TYPE: t3.small
  S3_BUCKET: 8-ktb-chat-common
  # ASG ê´€ë ¨ ì„¤ì •
  LAUNCH_TEMPLATE_NAME: ktb-chat-backend-template
  ASG_NAME: ktb-chat-backend-asg
  TARGET_GROUP_ARN: ${{ secrets.TARGET_GROUP_ARN }}  # ALB íƒ€ê²Ÿ ê·¸ë£¹ ARN

jobs:
  # ë°±ì—”ë“œ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  test:
    runs-on: ubuntu-latest
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js 18 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'

    - name: ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./backend
      run: npm ci

    - name: ë°±ì—”ë“œ ë¦°íŒ… (ì„ íƒì‚¬í•­)
      working-directory: ./backend
      run: |
        if npm list eslint >/dev/null 2>&1; then
          npm run lint
        else
          echo "ESLint ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤."
        fi
      continue-on-error: true

    - name: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      working-directory: ./backend
      run: |
        if npm run | grep -q "test"; then
          npm test
        else
          echo "í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤."
        fi
      continue-on-error: true

  # AMI ìƒì„± ë° ë°±ì—”ë“œ ë°°í¬
  build-ami:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: AWS ìžê²©ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ë¹Œë“œ ë©”íƒ€ë°ì´í„° ìƒì„±
      id: meta
      run: |
        # Git ì»¤ë°‹ í•´ì‹œì˜ ì§§ì€ ë²„ì „ ìƒì„±
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        
        # íƒ€ìž„ìŠ¤íƒ¬í”„ ìƒì„±
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # AMI ì´ë¦„ ìƒì„±
        AMI_NAME="ktb-chat-backend-jacky-${TIMESTAMP}-${SHORT_SHA}"
        
        echo "ami_name=${AMI_NAME}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "deployment_package=backend-${TIMESTAMP}-${SHORT_SHA}.tar.gz" >> $GITHUB_OUTPUT

    - name: ë°±ì—”ë“œ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      run: |
        echo "ðŸ“¦ ë°±ì—”ë“œ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì¤‘..."
        
        # ë°±ì—”ë“œ ì½”ë“œë§Œ ì••ì¶• (node_modules ì œì™¸)
        tar -czf ${{ steps.meta.outputs.deployment_package }} \
          --exclude=node_modules \
          --exclude=.git \
          --exclude='*.log' \
          --exclude='.env*' \
          --exclude='coverage' \
          --exclude='test' \
          backend/
        
        # ì••ì¶• íŒŒì¼ í¬ê¸° í™•ì¸
        echo "ì••ì¶• íŒŒì¼ í¬ê¸°:"
        ls -lh ${{ steps.meta.outputs.deployment_package }}

    - name: S3ì— ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
      run: |
        echo "â˜ï¸ S3ì— ë°±ì—”ë“œ ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ..."
        
        # S3 ë²„í‚· ì¡´ìž¬ í™•ì¸
        if ! aws s3 ls s3://${{ env.S3_BUCKET }} >/dev/null 2>&1; then
          echo "âŒ S3 ë²„í‚·ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${{ env.S3_BUCKET }}"
          exit 1
        fi
        
        # S3ì— ì—…ë¡œë“œ
        aws s3 cp ${{ steps.meta.outputs.deployment_package }} \
          s3://${{ env.S3_BUCKET }}/backend/deployments/${{ steps.meta.outputs.deployment_package }} \
          --metadata "commit-sha=${{ github.sha }},build-timestamp=${{ steps.meta.outputs.timestamp }},branch=jacky"
        
        echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ"

    - name: AMI ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      run: |
        echo "ðŸ“ AMI ì„¤ì •ì„ ìœ„í•œ User Data ìŠ¤í¬ë¦½íŠ¸ ìƒì„±..."
        
        cat > ami-setup.sh << 'EOF'
        #!/bin/bash
        
        # ë¡œê·¸ ì„¤ì •
        exec > >(tee /var/log/ami-setup.log) 2>&1
        echo "=== AMI ì„¤ì • ì‹œìž‘: $(date) ==="
        
        # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
        echo "ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ì¤‘..."
        yum update -y
        
        # Node.js 18 ì„¤ì¹˜
        echo "Node.js 18 ì„¤ì¹˜ ì¤‘..."
        curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
        yum install -y nodejs
        
        # PM2 ì „ì—­ ì„¤ì¹˜
        echo "PM2 ì„¤ì¹˜ ì¤‘..."
        npm install -g pm2
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìž ìƒì„±
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìž ìƒì„±..."
        useradd -m -s /bin/bash appuser
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ì„¤ì •..."
        mkdir -p /opt/ktb-chat-backend
        chown appuser:appuser /opt/ktb-chat-backend
        
        # AWS CLI ì„¤ì¹˜ (ìµœì‹  ë²„ì „)
        echo "AWS CLI ì„¤ì¹˜ ì¤‘..."
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        ./aws/install
        rm -rf aws awscliv2.zip
        
        # S3ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
        echo "S3ì—ì„œ ë°±ì—”ë“œ ì½”ë“œ ë‹¤ìš´ë¡œë“œ..."
        cd /opt/ktb-chat-backend
        aws s3 cp s3://${{ env.S3_BUCKET }}/backend/deployments/${{ steps.meta.outputs.deployment_package }} .
        tar -xzf ${{ steps.meta.outputs.deployment_package }}
        
        # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ì˜ì¡´ì„± ì„¤ì¹˜
        cd backend
        echo "ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
        npm ci --production
        
        # ì†Œìœ ê¶Œ ë³€ê²½
        chown -R appuser:appuser /opt/ktb-chat-backend
        
        # PM2 ecosystem íŒŒì¼ ìƒì„±
        cat > ecosystem.config.js << 'EOFPM2'
        module.exports = {
          apps: [{
            name: 'ktb-chat-backend',
            script: 'server.js',
            cwd: '/opt/ktb-chat-backend/backend',
            user: 'appuser',
            instances: 1,
            exec_mode: 'cluster',
            watch: false,
            max_memory_restart: '1G',
            env: {
              NODE_ENV: 'production',
              PORT: 5000
            },
            log_file: '/var/log/ktb-chat-backend.log',
            out_file: '/var/log/ktb-chat-backend-out.log',
            error_file: '/var/log/ktb-chat-backend-error.log',
            merge_logs: true,
            time: true
          }]
        };
        EOFPM2
        
        # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
        cat > /etc/systemd/system/ktb-chat-backend.service << 'EOFSYSTEMD'
        [Unit]
        Description=KTB Chat Backend Application
        After=network.target
        
        [Service]
        Type=forking
        User=appuser
        WorkingDirectory=/opt/ktb-chat-backend
        ExecStart=/usr/bin/pm2 start ecosystem.config.js --no-daemon
        ExecReload=/usr/bin/pm2 reload ecosystem.config.js
        ExecStop=/usr/bin/pm2 kill
        Restart=always
        RestartSec=10
        StandardOutput=syslog
        StandardError=syslog
        SyslogIdentifier=ktb-chat-backend
        
        [Install]
        WantedBy=multi-user.target
        EOFSYSTEMD
        
        # systemd ì„œë¹„ìŠ¤ í™œì„±í™” (ë¶€íŒ… ì‹œ ìžë™ ì‹œìž‘)
        systemctl daemon-reload
        systemctl enable ktb-chat-backend.service
        
        # ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •
        cat > /etc/logrotate.d/ktb-chat-backend << 'EOFLOGROTATE'
        /var/log/ktb-chat-backend*.log {
            daily
            rotate 30
            compress
            delaycompress
            missingok
            notifempty
            create 644 appuser appuser
            postrotate
                /usr/bin/pm2 reloadLogs
            endscript
        }
        EOFLOGROTATE
        
        # CloudWatch ì—ì´ì „íŠ¸ ì„¤ì¹˜
        echo "CloudWatch ì—ì´ì „íŠ¸ ì„¤ì¹˜..."
        yum install -y amazon-cloudwatch-agent
        
        # í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        cat > /usr/local/bin/health-check.sh << 'EOFHEALTH'
        #!/bin/bash
        # ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
        curl -f http://localhost:5000/health || exit 1
        EOFHEALTH
        chmod +x /usr/local/bin/health-check.sh
        
        # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f /opt/ktb-chat-backend/${{ steps.meta.outputs.deployment_package }}
        
        echo "=== AMI ì„¤ì • ì™„ë£Œ: $(date) ==="
        
        # ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸
        touch /tmp/ami-setup-complete
        EOF
        
        # ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        chmod +x ami-setup.sh

    - name: EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° AMI ë¹Œë“œ
      id: create-instance
      run: |
        echo "ðŸ–¥ï¸ AMI ë¹Œë“œìš© EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘..."
        
        # EC2 ì¸ìŠ¤í„´ìŠ¤ ì‹¤í–‰
        INSTANCE_ID=$(aws ec2 run-instances \
          --image-id ${{ env.BASE_AMI_ID }} \
          --instance-type ${{ env.INSTANCE_TYPE }} \
          --iam-instance-profile Name=EC2-S3-Access-Role \
          --user-data file://ami-setup.sh \
          --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=AMI-Build-${{ steps.meta.outputs.ami_name }}},{Key=Purpose,Value=AMI-Build},{Key=Application,Value=ktb-chat-backend}]' \
          --query 'Instances[0].InstanceId' \
          --output text)
        
        echo "instance_id=${INSTANCE_ID}" >> $GITHUB_OUTPUT
        echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ë¨: ${INSTANCE_ID}"
        
        # ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        echo "â³ ì¸ìŠ¤í„´ìŠ¤ ë¶€íŒ… ë° ì„¤ì • ëŒ€ê¸° ì¤‘..."
        aws ec2 wait instance-running --instance-ids ${INSTANCE_ID}
        
        # ì¶”ê°€ ëŒ€ê¸° ì‹œê°„ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜ ì™„ë£Œë¥¼ ìœ„í•´)
        echo "ðŸ“¦ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜ ì¤‘... (ì•½ 5ë¶„ ì†Œìš”)"
        sleep 300
        
        echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ì„¤ì • ì™„ë£Œ"

    - name: AMI ìƒì„±
      id: create-ami
      run: |
        echo "ðŸ“¸ AMI ìƒì„± ì¤‘..."
        
        # ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€
        echo "ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€ ì¤‘..."
        aws ec2 stop-instances --instance-ids ${{ steps.create-instance.outputs.instance_id }}
        aws ec2 wait instance-stopped --instance-ids ${{ steps.create-instance.outputs.instance_id }}
        
        # AMI ìƒì„±
        echo "AMI ìŠ¤ëƒ…ìƒ· ìƒì„± ì¤‘..."
        AMI_ID=$(aws ec2 create-image \
          --instance-id ${{ steps.create-instance.outputs.instance_id }} \
          --name "${{ steps.meta.outputs.ami_name }}" \
          --description "KTB Chat Backend AMI - jacky branch - Built on $(date)" \
          --no-reboot \
          --tag-specifications 'ResourceType=image,Tags=[{Key=Name,Value=${{ steps.meta.outputs.ami_name }}},{Key=Branch,Value=jacky},{Key=Application,Value=ktb-chat-backend},{Key=BuildTimestamp,Value=${{ steps.meta.outputs.timestamp }}}]' \
          --query 'ImageId' \
          --output text)
        
        echo "ami_id=${AMI_ID}" >> $GITHUB_OUTPUT
        echo "âœ… AMI ìƒì„±ë¨: ${AMI_ID}"
        
        # AMI ì‚¬ìš© ê°€ëŠ¥í•  ë•Œê¹Œì§€ ëŒ€ê¸°
        echo "â³ AMI ìƒì„± ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
        aws ec2 wait image-available --image-ids ${AMI_ID}
        
        echo "ðŸŽ‰ AMI ìƒì„± ì™„ë£Œ: ${AMI_ID}"

    # ASG Launch Template ì—…ë°ì´íŠ¸
    - name: Launch Template ì—…ë°ì´íŠ¸
      id: update-template
      run: |
        echo "ðŸš€ Launch Template ì—…ë°ì´íŠ¸ ì¤‘..."
        
        # ê¸°ì¡´ Launch Template í™•ì¸
        if aws ec2 describe-launch-templates --launch-template-names ${{ env.LAUNCH_TEMPLATE_NAME }} >/dev/null 2>&1; then
          echo "ê¸°ì¡´ Launch Template ë°œê²¬: ${{ env.LAUNCH_TEMPLATE_NAME }}"
          
          # ìƒˆ ë²„ì „ ìƒì„±
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --source-version '$Latest' \
            --launch-template-data '{
              "ImageId": "${{ steps.create-ami.outputs.ami_id }}",
              "TagSpecifications": [
                {
                  "ResourceType": "instance",
                  "Tags": [
                    {"Key": "Name", "Value": "ktb-chat-backend-instance"},
                    {"Key": "Application", "Value": "ktb-chat-backend"},
                    {"Key": "Environment", "Value": "production"},
                    {"Key": "Branch", "Value": "jacky"},
                    {"Key": "AMI-Version", "Value": "${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.short_sha }}"}
                  ]
                }
              ]
            }' \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)
          
          echo "template_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Launch Template ìƒˆ ë²„ì „ ìƒì„±ë¨: ${NEW_VERSION}"
          
          # ê¸°ë³¸ ë²„ì „ìœ¼ë¡œ ì„¤ì •
          aws ec2 modify-launch-template \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --default-version ${NEW_VERSION}
          
          echo "âœ… Launch Template ê¸°ë³¸ ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          
        else
          echo "Launch Templateì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤..."
          
          # ìƒˆ Launch Template ìƒì„±
          aws ec2 create-launch-template \
            --launch-template-name ${{ env.LAUNCH_TEMPLATE_NAME }} \
            --launch-template-data '{
              "ImageId": "${{ steps.create-ami.outputs.ami_id }}",
              "InstanceType": "t3.medium",
              "SecurityGroupIds": ["${{ secrets.BACKEND_SECURITY_GROUP_ID }}"],
              "IamInstanceProfile": {
                "Name": "EC2-S3-Access-Role"
              },
              "Monitoring": {
                "Enabled": true
              },
              "TagSpecifications": [
                {
                  "ResourceType": "instance",
                  "Tags": [
                    {"Key": "Name", "Value": "ktb-chat-backend-instance"},
                    {"Key": "Application", "Value": "ktb-chat-backend"},
                    {"Key": "Environment", "Value": "production"},
                    {"Key": "Branch", "Value": "jacky"},
                    {"Key": "AMI-Version", "Value": "${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.short_sha }}"}
                  ]
                }
              ]
            }'
          
          echo "template_version=1" >> $GITHUB_OUTPUT
          echo "âœ… ìƒˆ Launch Template ìƒì„± ì™„ë£Œ"
        fi

    # ASG ì—…ë°ì´íŠ¸
    - name: Auto Scaling Group ì—…ë°ì´íŠ¸
      run: |
        echo "ðŸ“ˆ Auto Scaling Group ì—…ë°ì´íŠ¸ ì¤‘..."
        
        # ASG ì¡´ìž¬ í™•ì¸
        if aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names ${{ env.ASG_NAME }} >/dev/null 2>&1; then
          echo "ê¸°ì¡´ ASG ë°œê²¬: ${{ env.ASG_NAME }}"
          
          # ASG Launch Template ì—…ë°ì´íŠ¸
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --launch-template LaunchTemplateName=${{ env.LAUNCH_TEMPLATE_NAME }},Version='$Latest'
          
          echo "âœ… ASG Launch Template ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          
          # ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì‹œìž‘ (ì ì§„ì  ë°°í¬)
          echo "ðŸ”„ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì‹œìž‘..."
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --preferences '{
              "InstanceWarmup": 300,
              "MinHealthyPercentage": 50,
              "CheckpointPercentages": [50],
              "CheckpointDelay": 600
            }' \
            --query 'InstanceRefreshId' \
            --output text)
          
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì‹œìž‘ë¨: ${REFRESH_ID}"
          echo "ðŸ“Š ìƒˆë¡œê³ ì¹¨ ì§„í–‰ ìƒí™©ì€ AWS ì½˜ì†”ì—ì„œ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
          
        else
          echo "âš ï¸ ASGê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${{ env.ASG_NAME }}"
          echo "ASGë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
        fi

    - name: ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
      if: always()
      run: |
        echo "ðŸ§¹ ë¹Œë“œìš© ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬ ì¤‘..."
        
        if [[ -n "${{ steps.create-instance.outputs.instance_id }}" ]]; then
          # ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ
          aws ec2 terminate-instances --instance-ids ${{ steps.create-instance.outputs.instance_id }}
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œë¨: ${{ steps.create-instance.outputs.instance_id }}"
        fi
        
        # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f ami-setup.sh
        rm -f ${{ steps.meta.outputs.deployment_package }}

    - name: AMI ì •ë³´ S3ì— ì €ìž¥
      if: success()
      run: |
        echo "ðŸ“„ AMI ì •ë³´ íŒŒì¼ ìƒì„± ë° S3 ì—…ë¡œë“œ..."
        
        # AMI ì •ë³´ JSON íŒŒì¼ ìƒì„±
        cat > ami-info.json << EOF
        {
          "amiId": "${{ steps.create-ami.outputs.ami_id }}",
          "amiName": "${{ steps.meta.outputs.ami_name }}",
          "buildTimestamp": "${{ steps.meta.outputs.timestamp }}",
          "commitSha": "${{ github.sha }}",
          "shortSha": "${{ steps.meta.outputs.short_sha }}",
          "branch": "jacky",
          "repository": "${{ github.repository }}",
          "workflow": "${{ github.workflow }}",
          "runId": "${{ github.run_id }}",
          "deploymentPackage": "${{ steps.meta.outputs.deployment_package }}",
          "baseAmiId": "${{ env.BASE_AMI_ID }}",
          "instanceType": "${{ env.INSTANCE_TYPE }}",
          "region": "${{ env.AWS_REGION }}",
          "launchTemplate": {
            "name": "${{ env.LAUNCH_TEMPLATE_NAME }}",
            "version": "${{ steps.update-template.outputs.template_version }}"
          },
          "asgName": "${{ env.ASG_NAME }}"
        }
        EOF
        
        # S3ì— AMI ì •ë³´ ì—…ë¡œë“œ
        aws s3 cp ami-info.json \
          s3://${{ env.S3_BUCKET }}/backend/ami-info/backend-ami-${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.short_sha }}.json
        
        # ìµœì‹  AMI ì •ë³´ë„ ì—…ë¡œë“œ
        aws s3 cp ami-info.json \
          s3://${{ env.S3_BUCKET }}/backend/ami-info/backend-ami-latest-jacky.json

    - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
      if: success()
      run: |
        echo "## ðŸŽ‰ ë°±ì—”ë“œ AMI ë¹Œë“œ ë° ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ AMI ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **AMI ID**: \`${{ steps.create-ami.outputs.ami_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **AMI ì´ë¦„**: \`${{ steps.meta.outputs.ami_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëžœì¹˜**: jacky" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¹Œë“œ ì‹œê°„**: ${{ steps.meta.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **Launch Template**: \`${{ env.LAUNCH_TEMPLATE_NAME }}\` (ë²„ì „ ${{ steps.update-template.outputs.template_version }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Auto Scaling Group**: \`${{ env.ASG_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œê³ ì¹¨**: ì§„í–‰ ì¤‘ (AWS ì½˜ì†”ì—ì„œ í™•ì¸)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š ëª¨ë‹ˆí„°ë§" >> $GITHUB_STEP_SUMMARY
        echo "- ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸: 5000" >> $GITHUB_STEP_SUMMARY
        echo "- í—¬ìŠ¤ì²´í¬: \`/health\` ì—”ë“œí¬ì¸íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "- ë¡œê·¸ ìœ„ì¹˜: \`/var/log/ktb-chat-backend*.log\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ S3 ì €ìž¥ ìœ„ì¹˜" >> $GITHUB_STEP_SUMMARY
        echo "- ë°°í¬ íŒ¨í‚¤ì§€: \`s3://${{ env.S3_BUCKET }}/backend/deployments/${{ steps.meta.outputs.deployment_package }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- AMI ì •ë³´: \`s3://${{ env.S3_BUCKET }}/backend/ami-info/backend-ami-${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.short_sha }}.json\`" >> $GITHUB_STEP_SUMMARY
